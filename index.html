<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mini Empires – Markt + Auto-Tore + Speichern</title>
<style>
:root{--bg:#101317;--panel:#171c22;--chip:#232a33;--text:#e7e9ee}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
#hud{position:fixed;left:0;right:0;top:0;padding:8px;display:flex;gap:8px;flex-wrap:wrap;z-index:10}
.chip{background:var(--chip);border:1px solid #2f3640;border-radius:999px;padding:7px 12px;font-weight:800;box-shadow:0 2px 0 rgba(0,0,0,.25)}
#bar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.3) 30%, rgba(0,0,0,.55));z-index:10}
.btn{background:var(--panel);border:1px solid #2f3640;border-radius:14px;padding:8px 12px;font-weight:800;min-width:124px;box-shadow:0 3px 0 rgba(0,0,0,.3);color:var(--text)}
.small{font-size:12px;opacity:.85}
.mode{position:fixed;right:10px;bottom:86px;background:#0b3b2a;border:1px solid #14532d;border-radius:12px;padding:6px 10px;font-size:12px;font-weight:800;letter-spacing:.3px;z-index:10}
.wave{position:fixed;right:10px;top:10px;background:#4b1d1d;border:1px solid #7f1d1d;padding:6px 10px;border-radius:10px;font-weight:800;z-index:10}
.hint{position:fixed;left:10px;bottom:86px;font-size:13px;color:#c8d1db;z-index:10}
canvas{display:block;touch-action:none}
#minimap{position:fixed;right:10px;bottom:10px;width:160px;height:90px;border:1px solid #1f2a44;background:#0b1220;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:9}
.tip{position:fixed;left:10px;bottom:142px;background:#0b1220;border:1px solid #1f2a44;border-radius:10px;padding:6px 10px;font-size:12px;display:none;z-index:11}
#start{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.8));display:flex;align-items:center;justify-content:center;z-index:50}
.card{background:#0b1220;border:1px solid #1f2a44;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.5);padding:18px;max-width:880px;width:calc(100% - 32px)}
.card h1{margin:0 0 10px;font-size:20px}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.pill{border-radius:999px;padding:8px 14px;border:1px solid #334155;background:#172032;cursor:pointer;font-weight:800}
.pill.active{outline:2px solid #38bdf8}
.startbtn{margin-top:10px;width:100%;padding:10px 14px;border-radius:12px;background:#1c3e1f;border:1px solid #2a6a2f;font-weight:900;letter-spacing:.3px}
.age{background:#142035;border:1px solid #284064}
.market{position:fixed;right:10px;bottom:110px;background:#0b1220;border:1px solid #1f2a44;border-radius:12px;padding:8px;display:none;z-index:11}
.market h3{margin:0 0 6px;font-size:13px}
.mrow{display:flex;gap:6px;flex-wrap:wrap}
.mbtn{background:#162033;border:1px solid #2a3850;border-radius:10px;padding:6px 8px;font-weight:800;color:#e7e9ee}
</style>
</head>
<body>

<!-- HUD -->
<div id="hud" hidden>
  <div class="chip">🌲 <span id="wood">0</span></div>
  <div class="chip">🍞 <span id="food">150</span></div>
  <div class="chip">🪨 <span id="stone">0</span></div>
  <div class="chip">🪙 <span id="gold">0</span></div>
  <div class="chip">👥 <span id="pop">0/10</span></div>
  <div class="chip age">🧭 <span id="age">Dorf</span></div>
  <div class="chip">🎯 <span id="sel">0</span></div>
  <button class="chip" id="bell" title="Alle Dorfbewohner garnisonieren">🔔</button>
  <button class="chip" id="ungarrison" style="display:none;" title="Garnison entlassen">🚪</button>
  <button class="chip" id="idle" title="Leerlaufende Dorfbewohner wählen">🟡 Idle</button>
  <button class="chip" id="saveBtn" title="Speichern (LocalStorage)">💾 Speichern</button>
  <button class="chip" id="loadBtn" title="Laden (LocalStorage)">📂 Laden</button>
</div>

<div class="wave" hidden>Welle: <span id="wave">0</span></div>
<div class="hint" hidden>Tippen: bewegen/auswählen • Ziehen: Mehrfachauswahl • Doppeltipp: Stop • Gebäude tippen → Rally • Tor tippen → öffnen • Markt: Trades</div>
<div class="mode" id="mode" hidden>Modus: Normal</div>
<div id="minimap"><canvas id="mini" width="160" height="90"></canvas></div>
<div class="tip" id="tip"></div>

<!-- Markt-Panel -->
<div class="market" id="marketPanel">
  <h3>🏛️ Markt – Kurse (Gebühr <span id="fee">7</span>%)</h3>
  <div class="mrow">
    <button class="mbtn" id="m_w2g">🌲→🪙 <span id="r_w2g">3:1</span></button>
    <button class="mbtn" id="m_g2w">🪙→🌲 <span id="r_g2w">1:2</span></button>
    <button class="mbtn" id="m_f2g">🍞→🪙 <span id="r_f2g">4:1</span></button>
    <button class="mbtn" id="m_g2f">🪙→🍞 <span id="r_g2f">1:3</span></button>
    <button class="mbtn" id="m_s2g">🪨→🪙 <span id="r_s2g">2:1</span></button>
    <button class="mbtn" id="m_g2s">🪙→🪨 <span id="r_g2s">1:2</span></button>
  </div>
</div>

<!-- Spielfeld -->
<canvas id="game" width="1024" height="576"></canvas>

<!-- Aktionsleiste -->
<div id="bar" hidden>
  <!-- Einheiten -->
  <button class="btn" id="spawnVillager" title="Dorfbewohner (50🍞)">👷 Villager</button>
  <button class="btn" id="trainMilitia"  title="Miliz (60🍞)">🛡️ Miliz</button>
  <button class="btn" id="trainSpearman" title="Speer (30🍞, 25🪨)">🗡️ Speer</button>
  <button class="btn" id="trainArcher"   title="Bogenschütze (30🍞, 30🪙)">🏹 Bogenschütze</button>
  <button class="btn" id="trainScout"    title="Späher (80🍞)">🐴 Späher</button>

  <!-- Bauen -->
  <button class="btn" id="b_house"      title="30🌲, +5 Pop">🏠 Haus</button>
  <button class="btn" id="b_farm"       title="60🌲">🌾 Farm</button>
  <button class="btn" id="b_mill"       title="100🌲">🛖 Mühle</button>
  <button class="btn" id="b_lumber"     title="100🌲">🪓 Holzlager</button>
  <button class="btn" id="b_mining"     title="100🌲">⛏️ Minenlager</button>
  <button class="btn" id="b_barracks"   title="175🌲">🏰 Kaserne</button>
  <button class="btn" id="b_archery"    title="200🌲">🏹 Bogenschützenplatz</button>
  <button class="btn" id="b_stable"     title="250🌲">🏇 Stall</button>
  <button class="btn" id="b_blacksmith" title="150🌲">⚒️ Schmiede</button>
  <button class="btn" id="b_market"     title="175🌲 100🪙 (Feudal)">🏛️ Markt</button>
  <button class="btn" id="b_tower"      title="200🪨 50🌲">🗼 Turm</button>
  <button class="btn" id="b_wall"       title="6🪨 je Segment (ziehen)">🧱 Wand</button>
  <button class="btn" id="b_gate"       title="60🪨 (auto-öffnet für eigene)">🚪 Tor</button>

  <!-- Forschung / Zeitalter -->
  <button class="btn" id="t_age"   title="Feudal 500🍞 • Ritter 800🍞+200🪙 • Kaiser 1000🍞+800🪙">⏫ Zeitalter</button>
  <button class="btn" id="t_loom"  title="Loom (50🍞) – Villager +HP">🧵 Loom</button>
  <button class="btn" id="t_horse" title="Horse Collar (75🍞) – Farmen +Ertrag">🐎 Horse Collar</button>
  <button class="btn" id="t_axe"   title="Double-Bit Axe (100🍞) – Holz +20%">🪓 Axt</button>
  <button class="btn" id="t_flet"  title="Fletching (150🪙) – Bogenschaden/Range +1">🏹 Fletching</button>
  <button class="btn" id="t_forg"  title="Forging (150🍞) – Nahkampf +1">🔨 Forging</button>
  <button class="btn" id="t_armor" title="Scale Mail (150🍞) – Rüstung +1">🛡️ Rüstung</button>
  <button class="btn" id="t_wheel" title="Wheelbarrow (175🍞 50🪙) – Villager Speed +10%">🛒 Schubkarre</button>

  <button class="btn" id="pauseBtn">⏸ Pause</button>
</div>

<!-- Startscreen -->
<div id="start">
  <div class="card">
    <h1>Spiel starten</h1>
    <div class="small">1) Schwierigkeit</div>
    <div class="row" id="row-diff">
      <div class="pill active" data-diff="leicht">Leicht</div>
      <div class="pill" data-diff="normal">Mittel</div>
      <div class="pill" data-diff="hart">Schwer</div>
      <div class="pill" data-diff="frieden">Friedlich</div>
    </div>
    <div class="small">2) Karte</div>
    <div class="row" id="row-map">
      <div class="pill active" data-map="wiese">Wiese</div>
      <div class="pill" data-map="wald">Waldreich</div>
      <div class="pill" data-map="berge">Bergland</div>
    </div>
    <button id="btn-start" class="startbtn">🎮 Spiel starten</button>
  </div>
</div>

<script>
/* ========= Utilities ========= */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const mini=document.getElementById('mini'), mctx=mini.getContext('2d');
const W=cvs.width, H=cvs.height, TILE=48;
const $=s=>document.querySelector(s), r=(a,b)=>Math.random()*(b-a)+a, clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
let paused=false, difficulty='leicht', wavesEnabled=true, lastTap=0, t=0;
let buildMode=null, wallPreview=null, rallyMode=false, selectedBuilding=null;
let _mouse=null, dragStart=null, dragging=false;

const UI={wood:$('#wood'),food:$('#food'),stone:$('#stone'),gold:$('#gold'),pop:$('#pop'),sel:$('#sel'),wave:$('#wave'),age:$('#age'),mode:$('#mode'),tip:$('#tip')};
const res={wood:0,food:150,stone:0,gold:0,cap:10,wave:0};
function showHUD(on){ ['#hud','#bar','#mode','.hint','.wave','#minimap','#marketPanel'].forEach(s=>$(s).hidden=!on); }
function updateHUD(){ UI.wood.textContent=res.wood; UI.food.textContent=res.food; UI.stone.textContent=res.stone; UI.gold.textContent=res.gold; UI.pop.textContent=`${friendly.length}/${res.cap}`; UI.sel.textContent=selected.size||0; UI.wave.textContent=res.wave; UI.age.textContent=AGE_NAMES[ageLevel]; }

/* ========= Data ========= */
const AGE_NAMES=['Dorf','Feudal','Ritter','Kaiser']; let ageLevel=0;
const DIFFS={frieden:{first:1e9,every:1e9,waveSize:w=>0},leicht:{first:240,every:150,waveSize:w=>1+w},normal:{first:150,every:120,waveSize:w=>2+Math.floor(w*1.5)},hart:{first:90,every:90,waveSize:w=>3+w*2}};
const costsAge=[{food:500},{food:800,gold:200},{food:1000,gold:800}];

const BUILD={
  tc:{hp:650,w:64,h:56,drop:true,age:0,cost:{}},
  house:{hp:260,w:36,h:32,age:0,cost:{wood:30},pop:+5},
  farm:{hp:240,w:40,h:36,age:0,cost:{wood:60}},
  mill:{hp:300,w:44,h:44,age:0,cost:{wood:100},drop:true},
  lumber:{hp:300,w:40,h:38,age:0,cost:{wood:100},drop:true},
  mining:{hp:300,w:40,h:38,age:0,cost:{wood:100},drop:true},
  barracks:{hp:420,w:56,h:44,age:0,cost:{wood:175}},
  archery:{hp:420,w:56,h:44,age:1,cost:{wood:200}},
  stable:{hp:480,w:56,h:44,age:1,cost:{wood:250}},
  blacksmith:{hp:380,w:48,h:40,age:1,cost:{wood:150}},
  market:{hp:420,w:54,h:44,age:1,cost:{wood:175,gold:100}},
  tower:{hp:460,w:32,h:48,age:1,cost:{stone:200,wood:50},tower:true},
  wall:{hp:180,seg:true,age:0,cost:{stone:6}},
  gate:{hp:360,w:36,h:16,age:1,cost:{stone:60},gate:true}
};

const UNITS={
  villager:{hp:60, spd:120, atk:4,  rng:16, rof:1.0, pop:1, age:0, role:'eco'},
  militia :{hp:90, spd:135, atk:10, rng:16, rof:0.8, pop:1, age:0, role:'melee'},
  spearman:{hp:85, spd:125, atk:8,  rng:16, rof:0.9, pop:1, age:1, role:'melee'},
  archer  :{hp:70, spd:130, atk:8,  rng:90, rof:0.8, pop:1, age:1, role:'ranged'},
  scout   :{hp:95, spd:170, atk:7,  rng:16, rof:0.7, pop:1, age:1, role:'cav'}
};
const COSTS_UNIT={ villager:{food:50}, militia:{food:60}, spearman:{food:30,stone:25}, archer:{food:30,gold:30}, scout:{food:80} };

const TECH={
  loom :{where:'tc', age:0, cost:{food:50},  apply:()=>{for(const u of friendly) if(u.type==='villager') u.max+=15,u.hp+=15; }},
  horse:{where:'mill', age:1, cost:{food:75}, apply:()=>{FARM_RATE*=1.25}},
  axe  :{where:'lumber',age:1, cost:{food:100},apply:()=>{GATHER_BOOST.wood=1.2}},
  flet :{where:'blacksmith',age:1, cost:{gold:150},apply:()=>{RANGED_BONUS.dmg+=1; RANGED_BONUS.rng+=6; for(const u of friendly) if(u.type==='archer'){u.atk+=1;u.range+=6;} }},
  forg :{where:'blacksmith',age:1, cost:{food:150},apply:()=>{MELEE_BONUS.dmg+=1; for(const u of friendly) if(u.role!=='ranged') u.atk+=1; }},
  armor:{where:'blacksmith',age:1, cost:{food:150},apply:()=>{ARMOR_BONUS.all+=1; for(const u of friendly) u.arm=(u.arm||0)+1; }},
  wheel:{where:'tc',age:1, cost:{food:175,gold:50},apply:()=>{for(const u of friendly) if(u.type==='villager') u.speed*=1.1; }}
};
let TECH_DONE={loom:false,horse:false,axe:false,flet:false,forg:false,armor:false,wheel:false};
let FARM_RATE=0.5;
const GATHER_BOOST={wood:1.0, stone:1.0, gold:1.0, food:1.0};
const RANGED_BONUS={dmg:0,rng:0}, MELEE_BONUS={dmg:0}, ARMOR_BONUS={all:0};

/* ========= Market model ========= */
const marketPanel=$('#marketPanel');
const feeEl=$('#fee');
let market={fee:7, w2g:3, g2w:2, f2g:4, g2f:3, s2g:2, g2s:2}; // X:1; inverse displayed as 1:X
function updRatesUI(){
  $('#r_w2g').textContent = `${market.w2g}:1`;
  $('#r_g2w').textContent = `1:${market.g2w}`;
  $('#r_f2g').textContent = `${market.f2g}:1`;
  $('#r_g2f').textContent = `1:${market.g2f}`;
  $('#r_s2g').textContent = `${market.s2g}:1`;
  $('#r_g2s').textContent = `1:${market.g2s}`;
  feeEl.textContent = market.fee;
}
function trade(from,to,rateIsFromPerGold){ // if true: X(from):1 gold; else 1 gold : X(to)
  let fee=1 - market.fee/100;
  if(rateIsFromPerGold){ // from -> gold
    if(res[from] < market[`${from[0]}2g`]) return;
    res[from] -= market[`${from[0]}2g`];
    res.gold += Math.max(1, Math.floor(1 * fee));
    market[`${from[0]}2g`] = Math.max(1, Math.ceil(market[`${from[0]}2g`] * 1.05)); // teurer
  } else { // gold -> to
    if(res.gold < 1) return;
    res.gold -= 1;
    res[to] += Math.max(1, Math.floor(market[`g2${to[0]}`] * fee));
    market[`g2${to[0]}`] = Math.max(1, Math.ceil(market[`g2${to[0]}`] * 0.98)); // billiger
  }
  updateHUD(); updRatesUI();
}
$('#m_w2g').onclick=()=>trade('wood','gold',true);
$('#m_f2g').onclick=()=>trade('food','gold',true);
$('#m_s2g').onclick=()=>trade('stone','gold',true);
$('#m_g2w').onclick=()=>trade('gold','wood',false);
$('#m_g2f').onclick=()=>trade('gold','food',false);
$('#m_g2s').onclick=()=>trade('gold','stone',false);

/* ========= Game state ========= */
const trees=[],rocks=[],golds=[],berries=[],buildings=[],walls=[],gates=[],friendly=[],enemy=[],projectiles=[];
const selected=new Set(); let waveTimer=0;

/* ========= Helpers ========= */
function pay(cost){ for(const k in cost){ if((res[k]||0)<cost[k]) return false; } for(const k in cost) res[k]-=cost[k]; updateHUD(); return true; }
function addBuilding(type,x,y,site=true){
  const bdef=BUILD[type]; const siteHP=bdef.hp*0.2;
  if(type==='wall'){ walls.push({x,y,hp:bdef.hp,max:bdef.hp}); return null; }
  const b={type,x,y,w:bdef.w||32,h:bdef.h||32,hp:site?siteHP:bdef.hp,max:bdef.hp,dropoff:!!bdef.drop,site,progress:site?0:1,queue:[],cd:0,rally:null,garrison:[],tower:!!bdef.tower,gate:!!bdef.gate,open:true};
  if(type==='gate'){ gates.push(b); return b; }
  buildings.push(b);
  if(BUILD[type].pop>0 && !site) res.cap+=BUILD[type].pop;
  if(type==='market' && !site){ marketPanel.style.display='block'; updRatesUI(); }
  return b;
}
function entityAt(list,x,y,rad){ return list.find(o=>Math.hypot(o.x-x,o.y-y)<rad && (o.hp??1)>0); }
function pickUnit(list,x,y){ return list.find(u=>Math.hypot(u.x-x,u.y-y)<(u.r+8)); }
function setTask(u,kind,target){ u.task=kind; u.target=target; u.tx=target.x; u.ty=target.y; u._t=0; }
function showTip(msg,ms=1600){ UI.tip.textContent=msg; UI.tip.style.display='block'; setTimeout(()=>UI.tip.style.display='none',ms); }

/* ========= Units ========= */
function makeUnit(kind,x,y){
  const d=UNITS[kind]; const u={team:1,type:kind,x,y,r:12,tx:x,ty:y,speed:d.spd,task:null,target:null,_t:0,
    hp:d.hp,max:d.hp,atk:d.atk+(d.role==='ranged'?RANGED_BONUS.dmg:0)+(d.role!=='ranged'?MELEE_BONUS.dmg:0),
    range:d.rng+(d.role==='ranged'?RANGED_BONUS.rng:0), rate:d.rof,last:0,arm:ARMOR_BONUS.all,
    role:d.role,hitfx:0,carry:{type:null,amt:0,cap:10},remember:null};
  return u;
}
const villager=(x,y)=>makeUnit('villager',x,y), militia=(x,y)=>makeUnit('militia',x,y), spearman=(x,y)=>makeUnit('spearman',x,y), archer=(x,y)=>makeUnit('archer',x,y), scout=(x,y)=>makeUnit('scout',x,y);
function raider(x,y){ const base={hp:70, spd:120, atk:8, rng:16, rof:0.9}; return {team:2,type:'raider',x,y,r:13,tx:x,ty:y,speed:base.spd,task:'raid',target:null,_t:0,hp:base.hp,max:base.hp,atk:base.atk,range:base.rng,rate:base.rof,last:0,arm:0,hitfx:0}; }
function arrow(x,y,tx,ty,atk,speed=420,team=1){ const ang=Math.atan2(ty-y,tx-x); return {x,y,dx:Math.cos(ang)*speed,dy:Math.sin(ang)*speed,ang,atk,team}; }

/* ========= Start / Map ========= */
let chosenDiff='leicht', chosenMap='wiese';
document.querySelectorAll('#row-diff .pill').forEach(p=>p.onclick=()=>{document.querySelectorAll('#row-diff .pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); chosenDiff=p.dataset.diff;});
document.querySelectorAll('#row-map .pill').forEach(p=>p.onclick=()=>{document.querySelectorAll('#row-map .pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); chosenMap=p.dataset.map;});
$('#btn-start').onclick=()=>startGame(chosenMap,chosenDiff);

function scatter(list,n,rad,padTop=90){ for(let i=0;i<n;i++) list.push({x:r(50,W-50),y:r(padTop,H-70),hp:rad*3,max:rad*3}); }
function startGame(map,diff){
  difficulty=diff; wavesEnabled=diff!=='frieden';
  trees.length=rocks.length=golds.length=berries.length=buildings.length=walls.length=gates.length=friendly.length=enemy.length=projectiles.length=0; selected.clear();
  Object.assign(res,{wood:0,food:150,stone:0,gold:0,cap:10,wave:0}); waveTimer=0; ageLevel=0;
  TECH_DONE={loom:false,horse:false,axe:false,flet:false,forg:false,armor:false,wheel:false};
  FARM_RATE=0.5; Object.assign(GATHER_BOOST,{wood:1,stone:1,gold:1,food:1}); Object.assign(RANGED_BONUS,{dmg:0,rng:0}); Object.assign(MELEE_BONUS,{dmg:0}); ARMOR_BONUS.all=0;
  market={fee:7,w2g:3,g2w:2,f2g:4,g2f:3,s2g:2,g2s:2}; updRatesUI();

  const S={wiese:{t:28,r:14,g:12,b:12},wald:{t:42,r:12,g:10,b:8},berge:{t:18,r:22,g:18,b:8}}[map]||{t:28,r:14,g:12,b:12};
  scatter(trees,S.t,18); scatter(rocks,S.r,18); scatter(golds,S.g,18); scatter(berries,S.b,16);

  addBuilding('tc',W/2,H/2,false);
  friendly.push(villager(W/2-24,H/2-8), villager(W/2+24,H/2-8), villager(W/2,H/2+28));
  selectUnits([friendly[0],friendly[1],friendly[2]]);
  initFog(); updateHUD();
  $('#start').style.display='none'; showHUD(true);
}

/* ========= Input ========= */
function selectUnits(arr){ selected.clear(); arr.forEach(u=>selected.add(u)); updateHUD(); }
function selectOne(u){ selected.clear(); if(u) selected.add(u); updateHUD(); }
function selectRect(x1,y1,x2,y2){ const minx=Math.min(x1,x2),maxx=Math.max(x1,x2),miny=Math.min(y1,y2),maxy=Math.max(y1,y2); selected.clear(); for(const u of friendly) if(u.x>=minx&&u.x<=maxx&&u.y>=miny&&u.y<=maxy) selected.add(u); if(selected.size===0 && friendly[0]) selected.add(friendly[0]); updateHUD(); }

function pos(e){ const b=cvs.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-b.left,y:t.clientY-b.top}; }
cvs.addEventListener('pointerdown',onDown,{passive:true});
cvs.addEventListener('pointermove',onMove,{passive:true});
cvs.addEventListener('pointerup',onUp,{passive:true});

function onDown(e){
  if($('#start').style.display!=='none') return;
  if(paused) return;
  const p=pos(e); _mouse=p; dragStart=p; dragging=false;
  const now=performance.now(), dbl=now-lastTap<250; lastTap=now;

  // Gate click: manual toggle (auto überschreibt später, aber manual wirkt sofort)
  const g=gates.find(g=>Math.abs(g.x-p.x)<(g.w/2+6)&&Math.abs(g.y-p.y)<(g.h/2+8));
  if(g && !buildMode){ g.open=!g.open; showTip(g.open?'Tor geöffnet':'Tor geschlossen'); return; }

  // Building tap → Rally
  const hitB=buildings.find(b=>Math.hypot(b.x-p.x,b.y-p.y) < (Math.max(b.w,b.h)/2)+8);
  if(hitB && !buildMode){
    selectedBuilding=hitB; rallyMode=true; UI.mode.hidden=false; UI.mode.textContent=`Rally für ${hitB.type.toUpperCase()} setzen: Boden tippen`;
    // Markt öffnen, wenn Markt
    if(hitB.type==='market' && !hitB.site){ marketPanel.style.display='block'; }
    return;
  }
  if(rallyMode && selectedBuilding && !hitB){
    selectedBuilding.rally={x:p.x,y:p.y}; rallyMode=false; selectedBuilding=null; UI.mode.textContent='Modus: Normal'; UI.mode.hidden=true; showTip('Rally gesetzt'); return;
  }

  const hit=pickUnit(friendly,p.x,p.y);
  if(hit && !dbl && !buildMode){ selectOne(hit); return; }

  if(buildMode){
    if(buildMode==='wall'){ wallPreview={x1:p.x,y1:p.y,x2:p.x,y2:p.y}; return; }
    if(buildMode==='gate'){ placeBuilding('gate',p.x,p.y); return; }
    placeBuilding(buildMode,p.x,p.y); return;
  }

  if(dbl){ for(const u of selected){u.task=null;u.target=null;u.tx=u.x;u.ty=u.y;u.remember=null;} return; }

  const tTree=entityAt(trees,p.x,p.y,22), tRock=entityAt(rocks,p.x,p.y,22), tGold=entityAt(golds,p.x,p.y,22), tBerry=entityAt(berries,p.x,p.y,20);
  const fFarm=buildings.find(b=>!b.site && b.type==='farm' && Math.hypot(b.x-p.x,b.y-p.y)<26);
  const foe=pickUnit(enemy,p.x,p.y);

  if(tTree||tRock||tGold||tBerry||fFarm){
    for(const u of selected){
      if(u.type!=='villager') continue;
      const tgt=tTree||tRock||tGold||tBerry||fFarm;
      const kind=tTree?'wood':tRock?'stone':tGold?'gold':tBerry?'food-node':'farm';
      setTask(u,kind,tgt); u.remember={kind,target:tgt};
    } return;
  }
  if(foe){ for(const u of selected){u.task='attack';u.target=foe;u.tx=foe.x;u.ty=foe.y;} return; }

  let i=0; for(const u of selected){ const offx=((i%3)-1)*10, offy=(Math.floor(i/3)-1)*10; i++; u.task='move'; u.target=null; u.tx=p.x+offx; u.ty=p.y+offy; u.remember=null; }
}
function onMove(e){ _mouse=pos(e); if(buildMode==='wall' && wallPreview){ wallPreview.x2=_mouse.x; wallPreview.y2=_mouse.y; } const s=dragStart; if(!s) return; const dx=_mouse.x-s.x, dy=_mouse.y-s.y; dragging=Math.hypot(dx,dy)>12; }
function onUp(){ if(dragging && dragStart && _mouse) selectRect(dragStart.x,dragStart.y,_mouse.x,_mouse.y); if(buildMode==='wall' && wallPreview){ placeWall(wallPreview); wallPreview=null; } dragStart=null; dragging=false; }

/* ========= Build placement ========= */
function canPlaceRect(x,y,w,h){ const far=44; const ok=o=>Math.hypot(o.x-x,o.y-y)>far; return buildings.every(ok)&&trees.every(ok)&&rocks.every(ok)&&golds.every(ok)&&berries.every(ok)&&gates.every(ok); }
function placeBuilding(type,x,y){
  const def=BUILD[type]; if(ageLevel<def.age){ showTip('Benötigt höheres Zeitalter'); return; }
  if(!pay(def.cost)) return;
  if(type==='wall'){ return; }
  if(!canPlaceRect(x,y,def.w||32,def.h||32)) return;
  addBuilding(type,x,y,true); buildMode=null; UI.mode.hidden=true;
}
function placeWall(seg){
  const dx=seg.x2-seg.x1, dy=seg.y2-seg.y1, len=Math.hypot(dx,dy), n=Math.max(1,Math.floor(len/20));
  const need=(BUILD.wall.cost.stone||0)*n; if(res.stone<need) return; res.stone-=need; updateHUD();
  for(let i=0;i<=n;i++){ const t=i/n, x=seg.x1+dx*t, y=seg.y1+dy*t; walls.push({x,y,hp:BUILD.wall.hp,max:BUILD.wall.hp}); }
}

/* ========= Buttons ========= */
const mapBtn=(id,mode,label)=>{ $(id).onclick=()=>{buildMode=mode; UI.mode.hidden=false; UI.mode.textContent='Bauen – '+label;}; };
mapBtn('#b_house','house','Haus'); mapBtn('#b_farm','farm','Farm'); mapBtn('#b_mill','mill','Mühle'); mapBtn('#b_lumber','lumber','Holzlager'); mapBtn('#b_mining','mining','Minenlager');
mapBtn('#b_barracks','barracks','Kaserne'); mapBtn('#b_archery','archery','Bogenschützenplatz'); mapBtn('#b_stable','stable','Stall'); mapBtn('#b_blacksmith','blacksmith','Schmiede');
mapBtn('#b_market','market','Markt'); mapBtn('#b_tower','tower','Turm'); mapBtn('#b_wall','wall','Wand (ziehen)'); mapBtn('#b_gate','gate','Tor');

$('#pauseBtn').onclick=()=>{ paused=!paused; $('#pauseBtn').textContent=paused?'▶ Weiter':'⏸ Pause'; };
function firstB(type){ return buildings.find(b=>!b.site && b.type===type); }
const unitTime={villager:10,militia:12,spearman:12,archer:12,scout:14};
function queueAt(b,kind){ if(!b) return false; if(friendly.length>=res.cap){ showTip('Bevölkerungsgrenze!'); return false; } if(!pay(COSTS_UNIT[kind])) return false; b.queue.push({kind,t:unitTime[kind]}); return true; }
$('#spawnVillager').onclick =()=> queueAt(firstB('tc'),'villager');
$('#trainMilitia').onclick  =()=> queueAt(firstB('barracks'),'militia');
$('#trainSpearman').onclick =()=> queueAt(firstB('barracks'),'spearman');
$('#trainArcher').onclick   =()=> queueAt(firstB('archery'),'archer');
$('#trainScout').onclick    =()=> queueAt(firstB('stable'),'scout');

$('#idle').onclick=()=>{ const idlers=friendly.filter(u=>u.type==='villager'&&(!u.task||u.task==='move')); if(idlers.length){ selectUnits(idlers); showTip(`Idle: ${idlers.length}`);} else showTip('Keine Idle 🙂',900); };
const bellBtn=$('#bell'), ungarrisonBtn=$('#ungarrison');
bellBtn.onclick=()=>{ const tc=firstB('tc'); if(!tc) return; for(const u of friendly){ if(u.type==='villager'){ u.task='garrison'; u.target=tc; u.tx=tc.x; u.ty=tc.y; } } ungarrisonBtn.style.display='inline-block'; };
ungarrisonBtn.onclick=()=>{ const tc=firstB('tc'); if(!tc) return; while(tc.garrison.length){ const u=tc.garrison.pop(); u.x=tc.x+r(-40,40); u.y=tc.y+r(-30,30); u.tx=u.x; u.ty=u.y; u.task=null; friendly.push(u);} ungarrisonBtn.style.display='none'; };

/* Zeitalter & Tech */
$('#t_age').onclick=()=>{ if(ageLevel>=3) return; const c=costsAge[ageLevel]; if(!pay(c)) return; ageLevel++; showTip('Neues Zeitalter: '+AGE_NAMES[ageLevel]); if(ageLevel>=1) res.cap+=5; if(ageLevel>=2) res.cap+=5; if(ageLevel>=3) res.cap+=10; updateHUD(); };
function research(key){ if(TECH_DONE[key]) return; const t=TECH[key]; if(ageLevel<t.age){ showTip('Benötigt höheres Zeitalter'); return; } if(t.where && !firstB(t.where)){ showTip('Benötigt '+t.where); return; } if(!pay(t.cost)) return; TECH_DONE[key]=true; t.apply(); showTip('Forschung: '+key); }
$('#t_loom').onclick =()=>research('loom'); $('#t_horse').onclick=()=>research('horse'); $('#t_axe').onclick=()=>research('axe'); $('#t_flet').onclick=()=>research('flet'); $('#t_forg').onclick=()=>research('forg'); $('#t_armor').onclick=()=>research('armor'); $('#t_wheel').onclick=()=>research('wheel');

/* Speichern / Laden */
$('#saveBtn').onclick=saveGame; $('#loadBtn').onclick=loadGame;
function saveGame(){
  const state={
    res, ageLevel, TECH_DONE, market, difficulty, map:chosenMap,
    buildings: buildings.map(b=>({type:b.type,x:b.x,y:b.y,hp:b.hp,site:b.site,progress:b.progress,rally:b.rally})),
    walls: walls.map(w=>({x:w.x,y:w.y,hp:w.hp})),
    gates: gates.map(g=>({x:g.x,y:g.y,hp:g.hp,open:g.open})),
    friendly: friendly.map(u=>({type:u.type,x:u.x,y:u.y,hp:u.hp})),
    enemy: enemy.map(u=>({x:u.x,y:u.y,hp:u.hp}))
  };
  localStorage.setItem('miniEmpiresSave', JSON.stringify(state));
  showTip('Gespeichert');
}
function loadGame(){
  const raw=localStorage.getItem('miniEmpiresSave'); if(!raw){ showTip('Kein Speicherstand'); return; }
  const s=JSON.parse(raw);
  // reset
  trees.length=rocks.length=golds.length=berries.length=buildings.length=walls.length=gates.length=friendly.length=enemy.length=projectiles.length=0; selected.clear();
  Object.assign(res,s.res); ageLevel=s.ageLevel; TECH_DONE=s.TECH_DONE; market=s.market; chosenMap=s.map; difficulty=s.difficulty; updRatesUI();
  // simple random map again (resources)
  const S={wiese:{t:28,r:14,g:12,b:12},wald:{t:42,r:12,g:10,b:8},berge:{t:18,r:22,g:18,b:8}}[chosenMap]||{t:28,r:14,g:12,b:12};
  scatter(trees,S.t,18); scatter(rocks,S.r,18); scatter(golds,S.g,18); scatter(berries,S.b,16);
  for(const b of s.buildings){ const nb=addBuilding(b.type,b.x,b.y,b.site); if(nb){ nb.hp=b.hp; nb.progress=b.progress; nb.rally=b.rally; if(nb.type==='market' && !nb.site) marketPanel.style.display='block'; } }
  for(const w of s.walls) walls.push({x:w.x,y:w.y,hp:w.hp,max:BUILD.wall.hp});
  for(const g of s.gates){ const ng=addBuilding('gate',g.x,g.y,false); ng.hp=g.hp; ng.open=g.open; }
  for(const u of s.friendly){ const nu=makeUnit(u.type,u.x,u.y); nu.hp=u.hp; friendly.push(nu); }
  for(const e of s.enemy){ const ne=raider(e.x,e.y); ne.hp=e.hp; enemy.push(ne); }
  initFog(); updateHUD(); $('#start').style.display='none'; showHUD(true); showTip('Geladen');
}

/* ========= Waves ========= */
function spawnWave(){ const conf=DIFFS[difficulty], n=Math.max(0,Math.floor(conf.waveSize(res.wave))); if(n<=0) return; res.wave++; for(let i=0;i<n;i++){ const edge=Math.floor(r(0,4)); let x,y; if(edge===0){x=-20;y=r(60,H-60);} if(edge===1){x=W+20;y=r(60,H-60);} if(edge===2){x=r(60,W-60);y=-20;} if(edge===3){x=r(60,W-60);y=H+20;} enemy.push(raider(x,y)); } updateHUD(); }

/* ========= Simulation ========= */
function nearestDropoff(obj){ let best=null,bd=1e9; for(const b of buildings){ if(b.dropoff && !b.site){ const d=Math.hypot(b.x-obj.x,b.y-obj.y); if(d<bd){bd=d;best=b;} } } return best; }
function nearest(list,from){ let best=null,bd=1e9; for(const t of list){ if(t.hp>0){ const d=dist(from,t); if(d<bd){ bd=d; best=t; } } } return best; }
function inSight(u,arr,rad){ let best=null,bd=1e9; for(const t of arr){ if(t.hp>0){ const d=dist(u,t); if(d<=rad && d<bd){ bd=d; best=t; } } } return best; }
function applyArmor(dmg,arm){ return Math.max(0.2, dmg - (arm||0)); }
function damage(obj,amt){ obj.hp=clamp(obj.hp-applyArmor(amt,obj.arm),0,obj.max); obj.hitfx=0.15; }
function shoot(from,tgt,atk,spd=420,team=1){ projectiles.push(arrow(from.x,from.y,tgt.x,tgt.y,atk,spd,team)); }

function stepProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i]; p.x+=p.dx*dt; p.y+=p.dy*dt;
    if(p.x<-30||p.x>W+30||p.y<-30||p.y>H+30){ projectiles.splice(i,1); continue; }
    const foes=p.team===1?enemy:friendly; let hit=null,hd=999;
    for(const u of foes){ const d=Math.hypot(u.x-p.x,u.y-p.y); if(d<12 && d<hd){ hd=d; hit=u; } }
    if(hit){ damage(hit,p.atk); projectiles.splice(i,1); }
  }
}

/* Auto-Gates: öffnen für eigene, schließen bei Gegnern */
function autoGates(){
  for(const g of gates){
    if(g.hp<=0) continue;
    const nearAlly = friendly.some(u=>Math.abs(u.x-g.x)<28 && Math.abs(u.y-g.y)<24);
    const nearEnemy= enemy.some(u=>Math.abs(u.x-g.x)<64 && Math.abs(u.y-g.y)<48);
    if(nearEnemy) g.open=false;
    else if(nearAlly) g.open=true;
  }
}

function stepUnits(list,dt,isFriendly){
  for(let i=list.length-1;i>=0;i--){
    const u=list[i];
    if(!isFriendly){ if(!u.target || u.target.hp<=0) u.target=nearest([...buildings,...friendly,...walls,...gates],u); if(u.target){ u.tx=u.target.x; u.ty=u.target.y; } }
    else if(u.task==='attack' && u.target && u.target.hp<=0){ u.task=null; }

    // Move
    const dx=u.tx-u.x, dy=u.ty-u.y, d=Math.hypot(dx,dy); if(d>1){ const s=u.speed*dt; u.x+=(dx/d)*Math.min(s,d); u.y+=(dy/d)*Math.min(s,d); }

    // Villager work
    if(isFriendly && u.type==='villager'){
      if(u.task==='garrison' && d<=18){ const tc=firstB('tc'); if(tc){ list.splice(i,1); tc.garrison.push(u); updateHUD(); continue; } }
      if(u.task && d<=14){
        u._t+=dt; if(u._t>=0.5){ u._t=0;
          const boost = (u.task==='wood')?GATHER_BOOST.wood:1.0;
          if(u.task==='wood' && u.target?.hp>0){u.target.hp-=2*boost;u.carry.type='wood';u.carry.amt+=2*boost;}
          else if(u.task==='stone' && u.target?.hp>0){u.target.hp-=2;u.carry.type='stone';u.carry.amt+=2;}
          else if(u.task==='gold' && u.target?.hp>0){u.target.hp-=2;u.carry.type='gold';u.carry.amt+=2;}
          else if(u.task==='food-node' && u.target?.hp>0){u.target.hp-=2;u.carry.type='food';u.carry.amt+=2;}
          else if(u.task==='farm'){u.carry.type='food';u.carry.amt+=3*FARM_RATE;}
          if(u.carry.amt>=u.carry.cap){const dpo=nearestDropoff(u); if(dpo){u.task='return';u.target=dpo;u.tx=dpo.x;u.ty=dpo.y;}}
        }
      }
      if(u.task==='return' && d<=18){
        if(u.carry.type){ res[u.carry.type]+=Math.round(u.carry.amt); u.carry.amt=0; updateHUD(); }
        if(u.remember && u.remember.target?.hp>0){ setTask(u,u.remember.kind,u.remember.target); } else u.task=null;
      }
      if(u.task==='build' && u.target && u.target.site){
        if(d<=18){ u._t+=dt; if(u._t>=0.25){ u._t=0; u.target.progress+=0.02; u.target.hp=clamp(u.target.hp+u.target.max*0.02,0,u.target.max); if(u.target.progress>=1){ u.target.site=false; if(u.target.type==='market') marketPanel.style.display='block'; } } }
      }
    }

    // Combat
    const foes=isFriendly?enemy:friendly;
    const tgt=(u.task==='attack'&&u.target)?u.target:inSight(u,foes,u.role==='ranged'?120:140);
    if(tgt){
      if(dist(u,tgt)<=u.range+2){
        u.last+=dt; if(u.last>=u.rate){ u.last=0; if(u.role==='ranged') shoot(u,tgt,u.atk,420,isFriendly?1:2); else damage(tgt,u.atk); }
      } else {
        const ang=Math.atan2(tgt.y-u.y,tgt.x-u.x), keep=u.range-4; u.tx=tgt.x-Math.cos(ang)*keep; u.ty=tgt.y-Math.sin(ang)*keep;
      }
    }
    if(u.hitfx>0) u.hitfx=Math.max(0,u.hitfx-dt*1.5);
  }
}

function processProduction(dt){
  for(const b of buildings){
    if(b.site) continue;
    if(!b.queue||!b.queue.length) continue;
    b.queue[0].t -= dt;
    if(b.queue[0].t<=0){
      const item=b.queue.shift(); let u=null;
      if(item.kind==='villager') u=villager(b.x,b.y);
      if(item.kind==='militia')  u=militia(b.x,b.y);
      if(item.kind==='spearman') u=spearman(b.x,b.y);
      if(item.kind==='archer')   u=archer(b.x,b.y);
      if(item.kind==='scout')    u=scout(b.x,b.y);
      if(u){ if(b.rally){u.x=b.x;u.y=b.y;u.tx=b.rally.x;u.ty=b.rally.y;u.task='move';} friendly.push(u); updateHUD(); }
    }
  }
}
function towersAndTC(dt){
  for(const b of buildings){
    if(b.site) continue;
    if(b.type==='tower'){ b.cd+=dt; if(b.cd>=0.8){b.cd=0; const tgt=nearest(enemy,b); if(tgt && dist(b,tgt)<=180) shoot(b,tgt,12,420,1);} }
    if(b.type==='tc'){ b.cd+=dt; const rate=1.2-0.05*b.garrison.length; if(b.cd>=Math.max(0.6,rate)){ b.cd=0; const tgt=nearest(enemy,b); if(tgt && dist(b,tgt)<=170){ let n=1+Math.min(4,b.garrison.length); while(n--) shoot(b,tgt,8,420,1);} } }
  }
}
function cleanDead(){ for(let i=friendly.length-1;i>=0;i--) if(friendly[i].hp<=0){ friendly.splice(i,1); updateHUD(); } for(let i=enemy.length-1;i>=0;i--) if(enemy[i].hp<=0) enemy.splice(i,1); for(let i=buildings.length-1;i>=0;i--) if(buildings[i].hp<=0) buildings.splice(i,1); for(let i=walls.length-1;i>=0;i--) if(walls[i].hp<=0) walls.splice(i,1); for(let i=gates.length-1;i>=0;i--) if(gates[i].hp<=0) gates.splice(i,1); }

/* ========= Fog of War ========= */
const CELL=24, COLS=Math.ceil(W/CELL), ROWS=Math.ceil(H/CELL);
let explored, visible;
function initFog(){ explored=[...Array(ROWS)].map(()=>Array(COLS).fill(false)); visible=[...Array(ROWS)].map(()=>Array(COLS).fill(false)); }
function resetVis(){ for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) visible[y][x]=false; }
function reveal(cx,cy,rad){ const R=Math.ceil(rad/CELL), gx=Math.floor(cx/CELL), gy=Math.floor(cy/CELL); for(let y=gy-R;y<=gy+R;y++){ if(y<0||y>=ROWS) continue; for(let x=gx-R;x<=gx+R;x++){ if(x<0||x>=COLS) continue; const wx=x*CELL+CELL/2, wy=y*CELL+CELL/2; if(Math.hypot(wx-cx,wy-cy)<=rad){ visible[y][x]=true; explored[y][x]=true; } } } }

/* ========= Rendering ========= */
function shadow(x,y,r){ ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(x,y+6,r*1.2,r*0.5,0,0,Math.PI*2); ctx.fill(); }
function hpbar(x,y,w,h,p,c){ ctx.fillStyle='#000a'; ctx.fillRect(x-w/2,y,w,h); ctx.fillStyle=c; ctx.fillRect(x-w/2,y,w*p,h); ctx.strokeStyle='#000'; ctx.strokeRect(x-w/2,y,w,h); }

function draw(){
  // Boden + leichtes Rauschen
  ctx.fillStyle='#18311f'; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=.06; ctx.fillStyle='#fff'; for(let y=0;y<H;y+=TILE) for(let x=0;x<W;x+=TILE) ctx.fillRect(x,y,1,1); ctx.globalAlpha=1;

  // Auswahlrechteck
  if(dragging && dragStart && _mouse){
    ctx.fillStyle='rgba(59,130,246,.15)'; ctx.strokeStyle='rgba(59,130,246,.8)'; ctx.setLineDash([6,4]);
    const x=dragStart.x,y=dragStart.y,w=_mouse.x-x,h=_mouse.y-y; ctx.fillRect(x,y,w,h); ctx.strokeRect(x,y,w,h); ctx.setLineDash([]);
  }

  // Ressourcen (Bäume/Fels/Gold/Beeren)
  const tree=o=>{ shadow(o.x,o.y,12); ctx.fillStyle='#2d5f3a'; ctx.beginPath(); ctx.arc(o.x,o.y-8,14,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#234a2c'; ctx.beginPath(); ctx.arc(o.x-8,o.y,10,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(o.x+8,o.y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#7a4a25'; ctx.fillRect(o.x-3,o.y+6,6,12); };
  const rock=o=>{ shadow(o.x,o.y,10); ctx.fillStyle='#9aa7b8'; ctx.beginPath(); ctx.moveTo(o.x-14,o.y+6); ctx.lineTo(o.x-4,o.y-8); ctx.lineTo(o.x+10,o.y-6); ctx.lineTo(o.x+14,o.y+8); ctx.closePath(); ctx.fill(); };
  const gold=o=>{ shadow(o.x,o.y,10); ctx.fillStyle='#f6c453'; ctx.beginPath(); ctx.moveTo(o.x-12,o.y+6); ctx.lineTo(o.x-2,o.y-8); ctx.lineTo(o.x+12,o.y-4); ctx.lineTo(o.x+14,o.y+8); ctx.closePath(); ctx.fill(); };
  const berr=o=>{ shadow(o.x,o.y,9); ctx.fillStyle='#14532d'; ctx.fillRect(o.x-14,o.y-8,28,16); ctx.fillStyle='#a11d1d'; for(let i=0;i<6;i++){ ctx.beginPath(); ctx.arc(o.x-9+i*4,o.y-2+r(-2,2),3,0,Math.PI*2); ctx.fill(); } };
  for(const o of trees) if(o.hp>0) tree(o);
  for(const o of rocks) if(o.hp>0) rock(o);
  for(const o of golds) if(o.hp>0) gold(o);
  for(const o of berries) if(o.hp>0) berr(o);

  // Walls & Gates
  for(const w of walls){ shadow(w.x,w.y,6); ctx.fillStyle='#7d8798'; ctx.beginPath(); ctx.arc(w.x,w.y,6,0,Math.PI*2); ctx.fill(); if(w.hp<w.max){ ctx.fillStyle='rgba(0,0,0,.4)'; ctx.fillRect(w.x-8,w.y-12,16,4); ctx.fillStyle='#93c5fd'; ctx.fillRect(w.x-8,w.y-12,16*(w.hp/w.max),4); } }
  for(const g of gates){ shadow(g.x,g.y,14); ctx.fillStyle=g.open?'#8fb98f':'#9aa3af'; ctx.fillRect(g.x-(g.w/2), g.y-(g.h/2), g.w, g.h); ctx.strokeStyle=g.open?'#34d399':'#f59e0b'; ctx.strokeRect(g.x-(g.w/2), g.y-(g.h/2), g.w, g.h); hpbar(g.x,g.y-24,46,5,g.hp/g.max,'#22c55e'); }

  // Buildings
  for(const b of buildings){
    shadow(b.x,b.y,(Math.max(b.w,b.h)/2));
    if(b.type==='tc'){ ctx.fillStyle=b.site?'#9aa0a6':'#d1d5db'; ctx.fillRect(b.x-32,b.y-26,64,52); ctx.fillStyle='#92400e'; ctx.fillRect(b.x-32,b.y-26,64,10); }
    else if(b.type==='house'){ ctx.fillStyle=b.site?'#7b828c':'#9ca3af'; ctx.fillRect(b.x-18,b.y-16,36,32); }
    else if(b.type==='farm'){ ctx.fillStyle=b.site?'#315a3a':'#166534'; ctx.fillRect(b.x-22,b.y-18,44,36); if(!b.site){ ctx.fillStyle='rgba(255,255,255,.18)'; for(let i=-14;i<=14;i+=7) ctx.fillRect(b.x-22,b.y+i,44,2); } }
    else if(b.type==='mill'){ ctx.fillStyle=b.site?'#5b43a8':'#7c5cf6'; ctx.fillRect(b.x-22,b.y-22,44,44); }
    else if(b.type==='lumber'){ ctx.fillStyle=b.site?'#3c4f3f':'#4c6b54'; ctx.fillRect(b.x-20,b.y-18,40,36); }
    else if(b.type==='mining'){ ctx.fillStyle=b.site?'#49505c':'#596275'; ctx.fillRect(b.x-20,b.y-18,40,36); }
    else if(b.type==='barracks'){ ctx.fillStyle=b.site?'#2b2f36':'#374151'; ctx.fillRect(b.x-28,b.y-22,56,44); }
    else if(b.type==='archery'){ ctx.fillStyle=b.site?'#253044':'#2c3e57'; ctx.fillRect(b.x-28,b.y-22,56,44); }
    else if(b.type==='stable'){ ctx.fillStyle=b.site?'#3a2a1f':'#5b3f2b'; ctx.fillRect(b.x-28,b.y-22,56,44); }
    else if(b.type==='blacksmith'){ ctx.fillStyle=b.site?'#34353c':'#44464f'; ctx.fillRect(b.x-24,b.y-20,48,40); }
    else if(b.type==='market'){ ctx.fillStyle=b.site?'#2a2436':'#3c3250'; ctx.fillRect(b.x-27,b.y-21,54,42); }
    else if(b.type==='tower'){ ctx.fillStyle=b.site?'#7f8ea3':'#9ca3af'; ctx.fillRect(b.x-16,b.y-24,32,48); }
    const prog=b.site?b.progress:(b.hp/b.max); hpbar(b.x,b.y-34,46,5,prog,b.site?'#f59e0b':'#22c55e');
    if(!b.site && b.queue && b.queue.length){
      const icons={villager:'👷',militia:'🛡️',spearman:'🗡️',archer:'🏹',scout:'🐴'}; let ix=-Math.min(5,b.queue.length)*10;
      for(let i=0;i<Math.min(5,b.queue.length);i++){ ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(b.x-6+ix,b.y-46,12,12); ctx.fillStyle='#fff'; ctx.font='10px system-ui'; ctx.fillText(icons[b.queue[i].kind]||'•', b.x-5+ix, b.y-36); ix+=12; }
    }
    if(b.rally){ ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.beginPath(); ctx.arc(b.rally.x,b.rally.y,7,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.rally.x,b.rally.y); ctx.stroke(); }
  }

  // Projectiles
  for(const p of projectiles){ ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.ang); ctx.fillStyle='#e5e7eb'; ctx.fillRect(-6,-1,12,2); ctx.fillStyle='#8b5e3c'; ctx.fillRect(4,-2,6,4); ctx.restore(); }

  // Units
  for(const u of enemy) drawUnit(u,false);
  for(const u of friendly) drawUnit(u,true);

  // Selection rings
  ctx.strokeStyle='#38bdf8'; ctx.setLineDash([4,4]); for(const u of selected){ ctx.beginPath(); ctx.arc(u.x,u.y,u.r+4,0,Math.PI*2); ctx.stroke(); } ctx.setLineDash([]);

  // Fog of War
  resetVis();
  for(const u of friendly) reveal(u.x,u.y,110);
  for(const b of buildings) if(!b.site) reveal(b.x,b.y,120);
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++){ if(visible[y][x]) continue; const px=x*CELL, py=y*CELL; ctx.fillStyle= explored[y][x]?'rgba(0,0,0,.45)':'rgba(0,0,0,.85)'; ctx.fillRect(px,py,CELL,CELL); }
}
function drawUnit(u,ally){
  shadow(u.x,u.y,u.r);
  if(u.hitfx>0){ ctx.save(); ctx.globalAlpha=0.8*u.hitfx; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(u.x,u.y,u.r+1,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  let head=u.type==='villager'?'#d1a46f':(u.role==='ranged'?'#6aa2ff':ally?'#d46e6e':'#ef4444');
  ctx.fillStyle=head; ctx.beginPath(); ctx.arc(u.x,u.y-6,6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle= ally ? '#2f3a4a' : '#451a1a'; ctx.fillRect(u.x-6,u.y-4,12,12);
  ctx.strokeStyle=(u.role==='ranged')?'#8b5e3c':'#9ca3af'; ctx.lineWidth=2;
  if(u.role==='ranged'){ ctx.beginPath(); ctx.arc(u.x+6,u.y,6,-Math.PI/2,Math.PI/2); ctx.stroke(); } else { ctx.beginPath(); ctx.moveTo(u.x+8,u.y+6); ctx.lineTo(u.x+14,u.y+2); ctx.stroke(); }
  ctx.fillStyle='#0009'; ctx.fillRect(u.x-12,u.y-u.r-12,24,4);
  ctx.fillStyle='#22c55e'; ctx.fillRect(u.x-12,u.y-u.r-12,24*(u.hp/u.max),4);
}

/* ========= Minimap ========= */
function drawMini(){
  const mw=mini.width, mh=mini.height, sx=mw/W, sy=mh/H;
  mctx.fillStyle='#0e1726'; mctx.fillRect(0,0,mw,mh);
  mctx.fillStyle='#22c55e'; for(const o of trees) if(o.hp>0) mctx.fillRect(o.x*sx,o.y*sy,2,2);
  mctx.fillStyle='#94a3b8'; for(const o of rocks) if(o.hp>0) mctx.fillRect(o.x*sx,o.y*sy,2,2);
  mctx.fillStyle='#fbbf24'; for(const o of golds) if(o.hp>0) mctx.fillRect(o.x*sx,o.y*sy,2,2);
  mctx.fillStyle='#60a5fa'; for(const b of buildings) if(!b.site) mctx.fillRect((b.x-4)*sx,(b.y-4)*sy,4,4);
  mctx.fillStyle='#a3e635'; for(const g of gates) mctx.fillRect((g.x-2)*sx,(g.y-2)*sy,4,4);
  mctx.fillStyle='#22d3ee'; for(const u of friendly) mctx.fillRect(u.x*sx,u.y*sy,2,2);
  mctx.fillStyle='#ef4444'; for(const u of enemy)    mctx.fillRect(u.x*sx,u.y*sy,2,2);
  mctx.strokeStyle='#475569'; mctx.strokeRect(0,0,mw-0.5,mh-0.5);
}

/* ========= Events ========= */
cvs.addEventListener('dblclick',e=>{
  const p=pos(e); const site=buildings.find(b=>b.site && Math.hypot(b.x-p.x,b.y-p.y) < (Math.max(b.w,b.h)/2)+8);
  if(site){ for(const u of selected) if(u.type==='villager') setTask(u,'build',site); showTip('Baustelle zugewiesen'); }
});

/* ========= Loop ========= */
let last=0;
function loop(ts){
  const dt=Math.min(0.033,(ts-last)/1000); last=ts; t+=dt;
  if($('#start').style.display==='none' && !paused){
    if(wavesEnabled){ const conf=DIFFS[difficulty]; waveTimer+=dt; const due=(res.wave===0)?conf.first:conf.every; if(waveTimer>=due){ waveTimer=0; spawnWave(); } }
    autoGates();
    stepUnits(friendly,dt,true);
    stepUnits(enemy,dt,false);
    processProduction(dt);
    towersAndTC(dt);
    farmsPassive(dt);
    stepProjectiles(dt);
    cleanDead();
  }
  draw(); drawMini();
  requestAnimationFrame(loop);
}
function farmsPassive(dt){ for(const b of buildings){ if(!b.site && b.type==='farm'){ b._p=(b._p||0)+dt; if(b._p>2){ b._p=0; res.food+=FARM_RATE*2; updateHUD(); } } } }

/* ========= Start ========= */
requestAnimationFrame(loop);
</script>
</body>
</html>
